<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping and Analyzing Environmental Inequality in the U.S.</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        /* D3 specific styles */
        .d3-bar { 
            fill: #2e1065; 
            cursor: pointer;
            transition: fill 0.3s;
        }
        .d3-bar:hover { 
            fill: #6b21a8; 
        }
        .d3-axis { 
            font: 12px sans-serif; 
        }
        .d3-axis path, 
        .d3-axis line { 
            fill: none; 
            stroke: #000; 
            shape-rendering: crispEdges; 
        }
        .d3-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            font-size: 12px;
            z-index: 1000;
        }
        .d3-chart-container {
            position: relative;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <h1>Environmental Inequality in the U.S.</h1>
                <ul class="nav-links">
                    <li><a href="#introduction">Introduction</a></li>
                    <li><a href="#data">Data</a></li>
                    <li><a href="#visualizations">Visualizations</a></li>
                    <li><a href="#findings">Findings</a></li>
                    <li><a href="#team">Team</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <!-- Introduction Section -->
        <section id="introduction" class="section">
            <div class="container">
                <h2>Introduction</h2>
                <div class="intro-content">
                    <p>Across the United States, many communities face long-term health consequences from industrial activity and environmental neglect. Incidents such as toxic chemical releases, lead contamination, and poor air quality highlight how pollution disproportionately affects low-income areas and people of color.</p>
                    
                    <p>Understanding these disparities is critical for identifying where policy and intervention are most needed. By examining the relationship between pollution exposure, socioeconomic factors, and health outcomes, this project seeks to uncover patterns of environmental injustice and health disparities.</p>
                    
                    <p>Studying these connections not only reveals the human cost of industrial and governmental oversight but also emphasizes the urgent need for equitable public health protections and sustainable environmental practices.</p>
                </div>
                
                <div class="reference-images">
                    <div class="reference-image">
                        <img src="images/ref_image_1.png" alt="Environmental Health Context - Reference Image 1" style="width: 85%; height: 315px; object-fit: cover; border-radius: 8px;">
                        <p class="image-caption">Reference Image 1: Environmental Health Context</p>
                    </div>
                    <div class="reference-image">
                        <img src="images/ref_image_2.png" alt="Community Impact Visualization - Reference Image 2" style="width: 85%; height: 315px; object-fit: cover; border-radius: 8px;">
                        <p class="image-caption">Reference Image 2: Community Impact Visualization</p>
                    </div>
                </div>

                <div class="references">
                    <h3>References</h3>
                    <ul>
                        <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5555375/" target="_blank">Social and Built Environmental Correlates of Predicted Blood Lead Levels in the Flint Water Crisis - PMC</a></li>
                        <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8234030/" target="_blank">Air pollution and its impact on cancer incidence, cancer care and cancer outcomes - PMC</a></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Data Section -->
        <section id="data" class="section">
            <div class="container">
                <h2>Data Sources and Methodology</h2>
                <p>This analysis combines multiple county-level datasets to examine environmental health disparities across the United States. Our data sources include comprehensive environmental, demographic, and health indicators necessary to identify patterns of environmental injustice.</p>
                
                <div class="data-grid">
                    <div class="data-card">
                        <h4>Socioeconomic Data</h4>
                        <ul>
                            <li>Poverty Data 2023 (~3,000 counties)</li>
                            <li>Corrected county demographics</li>
                            <li>2024 US census data</li>
                        </ul>
                    </div>
                    <div class="data-card">
                        <h4>Environmental Exposure</h4>
                        <ul>
                            <li>HDPulse environmental data export</li>
                            <li>Corrected facilities data</li>
                            <li>Integrated environmental indicators</li>
                        </ul>
                    </div>
                    <div class="data-card">
                        <h4>Health Outcomes</h4>
                        <ul>
                            <li>County COPD prevalence data</li>
                            <li>Incidence and mortality rates (incd.csv)</li>
                            <li>Merged final health indicators</li>
                        </ul>
                    </div>
                </div>

                <div class="methodology">
                    <h3>Data Processing Methodology</h3>
                    <p>All datasets were merged using Federal Information Processing Standards (FIPS) codes to ensure accurate county-level alignment. Missing data was handled through careful imputation and outlier analysis. Variables were standardized for cross-county comparison and converted to geospatial format for mapping applications.</p>
                </div>
            </div>
        </section>

        <!-- Visualizations Section -->
        <section id="visualizations" class="section">
            <div class="container">
                <h2>Interactive Data Visualizations</h2>
                <p>Explore the relationship between environmental factors, demographics, and health outcomes through our interactive visualizations.</p>

                <!-- Interactive Air Pollution vs COPD Scatter Plot (Altair) -->
                <div class="visualization-container">
                    <h3>Air Pollution vs. COPD Prevalence (Interactive Altair)</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> 
                        <br>• <strong>Brush Selection:</strong> Drag to create a rectangular selection - selected points become bright and prominent while unselected points fade to very low opacity
                        <br>• <strong>Click Points:</strong> Click individual points to select them (they get larger with black outline)
                        <br>• <strong>Hover:</strong> Mouse over any point for detailed county information
                        <br><br>This scatter plot shows the relationship between air pollution concentration (µg/m³) and COPD prevalence (%) across U.S. counties, with each point colored by the number of industrial facilities in that county.</p>
                    </div>
                    <div class="visualization">
                        <div id="scatter-plot-viz" style="width: 100%;"></div>
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>While there's significant variation in the relationship between air pollution and COPD rates, counties with higher concentrations of industrial facilities (shown in brighter colors) tend to cluster in areas with elevated air pollution levels, suggesting industrial activity as a key contributor to local air quality issues.</p>
                    </div>
                </div>

                <!-- D3.js Top Counties Bar Chart -->
                <div class="visualization-container">
                    <h3>Top 20 Counties by Industrial Facilities (Interactive D3.js)</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> Hover for detailed information, click bars to highlight. This bar chart uses D3.js to show the 20 U.S. counties with the highest number of industrial facilities, with interactive hover tooltips and click selection.</p>
                        <p><strong>Design Rationale:</strong> Implemented in pure D3.js with custom color scaling using d3.interpolateViridis. Horizontal bar chart design allows for easy reading of county names. Interactive features include hover tooltips with comprehensive county information and click selection that highlights selected counties while dimming others.</p>
                    </div>
                    <div class="d3-chart-container">
                        <div id="d3-facilities-bar-chart" style="width: 100%;"></div>
                        <div class="d3-tooltip"></div>
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Industrial facilities are heavily concentrated in major metropolitan areas, with Harris County, TX leading significantly. This concentration pattern reveals environmental justice concerns as these high-facility counties often correspond with areas of greater population density and potentially vulnerable communities.</p>
                    </div>
                </div>

                <!-- Interactive Water Violations Bar Chart (Altair) -->
                <div class="visualization-container">
                    <h3>Water Quality Violations by Demographics (Interactive Altair)</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> Hover for detailed counts and percentages, click bars to highlight. This bar chart shows how many U.S. counties with drinking water violations fall into each majority race or ethnicity category.</p>
                        <p><strong>Design Rationale:</strong> Uses a consistent purple color scheme (#3b0764) to maintain visual cohesion with other visualizations. Bars are sorted by count to emphasize the most affected demographic groups. Interactive click selection allows users to focus on specific demographic categories.</p>
                    </div>
                    <div class="visualization">
                        <div id="water-violations-viz" style="width: 100%;"></div>
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Water quality violations affect communities across all demographic groups, with the distribution largely reflecting the overall U.S. population demographics. This suggests that water infrastructure challenges are widespread rather than concentrated in specific racial or ethnic communities.</p>
                    </div>
                </div>

<!-- Air Pollution Choropleth Map -->
                <div class="visualization-container">
                    <h3>County-Level Air Pollution Distribution</h3>
                    <div class="viz-description">
                        <p>This choropleth map displays normalized air pollution levels (PM2.5 in µg/m³) across U.S. counties using a blue color scale. Darker blue indicates higher pollution concentrations, revealing geographic patterns of air quality across the nation.</p>
                        <p><strong>Design Rationale:</strong> Implemented using Plotly with a blue color scale to intuitively represent air quality (darker = worse air). Data was normalized across counties to highlight relative differences in pollution exposure levels.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/air_pollution_map.png" alt="County-Level Air Pollution Distribution Map" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Air pollution shows distinct geographic clustering, with elevated concentrations in major metropolitan areas and industrial regions, particularly in California's Central Valley and parts of the Midwest and Southeast, highlighting areas where air quality regulations and monitoring may need increased attention.</p>
                    </div>
                </div>

                <!-- Cancer Incidence Choropleth Map -->
                <div class="visualization-container">
                    <h3>County-Level Cancer Incidence Distribution</h3>
                    <div class="viz-description">
                        <p>This choropleth map shows the log-scaled average annual cancer count across U.S. counties using a purple color scale. The logarithmic transformation helps visualize the wide range of cancer incidence rates while highlighting geographic patterns.</p>
                        <p><strong>Design Rationale:</strong> Used log transformation to handle the wide range in cancer counts (from low rural counties to high urban areas). Purple color scheme maintains visual consistency with the overall design while clearly distinguishing this health outcome variable.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/cancer_incidence_map.png" alt="County-Level Cancer Incidence Distribution Map" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Cancer incidence shows strong correlation with population density, with highest rates concentrated in major metropolitan areas. However, certain rural regions also show elevated rates, suggesting that factors beyond just population size may contribute to cancer burden in specific geographic areas.</p>
                    </div>
                </div>

                <!-- COPD Prevalence Choropleth Map -->
                <div class="visualization-container">
                    <h3>County-Level COPD Prevalence Distribution</h3>
                    <div class="viz-description">
                        <p>This choropleth map displays normalized COPD prevalence rates across U.S. counties using a green color scale. The map reveals regional patterns in respiratory health outcomes and their potential relationship to environmental and socioeconomic factors.</p>
                        <p><strong>Design Rationale:</strong> Green color scale was chosen to represent health outcomes (darker green = higher COPD rates). Data normalization allows for direct comparison across counties with different baseline health profiles.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/copd_prevalence_map.png" alt="County-Level COPD Prevalence Distribution Map" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>COPD prevalence shows distinct regional clustering, with notably higher rates in parts of Appalachia, the Southeast, and certain areas along the Arizona-New Mexico border. This geographic pattern suggests that environmental, economic, and lifestyle factors may combine to create respiratory health disparities in specific regions.</p>
                    </div>
                </div>

                <!-- Poverty Rate Choropleth Map -->
                <div class="visualization-container">
                    <h3>County-Level Poverty Rate Distribution</h3>
                    <div class="viz-description">
                        <p>This choropleth map visualizes normalized poverty rates across U.S. counties using a red color scale, providing crucial socioeconomic context for understanding environmental health disparities and their intersection with economic disadvantage.</p>
                        <p><strong>Design Rationale:</strong> Red color scale effectively communicates the intensity of economic disadvantage (darker red = higher poverty). The normalization process ensures that relative poverty levels are comparable across all counties regardless of their baseline economic conditions.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/poverty_rate_map.png" alt="County-Level Poverty Rate Distribution Map" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Poverty rates show clear geographic clustering, with higher concentrations in rural areas of the South, parts of Appalachia, Native American reservations, and specific metropolitan areas. This economic geography provides essential context for understanding how socioeconomic disadvantage may compound environmental health risks in vulnerable communities.</p>
                    </div>
                </div>
        </section>

        <!-- Findings Section -->
        <section id="findings" class="section">
            <div class="container">
                <h2>Summary of Findings</h2>
                
                <div class="findings-summary">
                    <p>Through comprehensive analysis of environmental, demographic, and health data across U.S. counties, this study reveals significant patterns of environmental inequality and their relationship to public health outcomes. Our visualizations demonstrate clear connections between industrial activity, environmental quality, and community health disparities.</p>
                </div>
                
                <div class="findings-grid">
                    <div class="finding-card">
                        <h3>Industrial Activity Concentration</h3>
                        <p>Industrial facilities are heavily concentrated in major metropolitan areas like Harris County, TX and Los Angeles County, CA, with the top 20 counties containing disproportionate numbers of facilities. This concentration creates localized environmental burden hotspots with significant implications for air and water quality in these regions.</p>
                    </div>
                    
                    <div class="finding-card">
                        <h3>Air Pollution and Respiratory Health</h3>
                        <p>The relationship between air pollution and COPD prevalence shows that while pollution is not the sole factor affecting respiratory health, counties with higher industrial facility counts consistently show elevated air pollution levels, creating identifiable hotspots for poor air quality and higher COPD rates.</p>
                    </div>
                    
                    <div class="finding-card">
                        <h3>Water Quality Across Demographics</h3>
                        <p>Water quality violations occur across communities of different racial and ethnic majorities, with the majority of affected counties being predominantly White. This pattern reflects broader population demographics but also demonstrates that water quality issues span diverse communities rather than being concentrated in specific demographic groups.</p>
                    </div>
                </div>

                <div class="future-work">
                    <h3>Future Research and Policy Implications</h3>
                    <p>Future research should examine longitudinal trends in environmental health disparities, investigate the effectiveness of current environmental regulations in high-burden areas, and explore targeted interventions for communities facing multiple environmental stressors. Policy makers should consider the concentrated nature of industrial activity when developing environmental health protections and ensure equitable enforcement across all communities.</p>
                </div>
            </div>
        </section>

        <!-- Team Section -->
        <section id="team" class="section">
            <div class="container">
                <h2>Project Team</h2>
                <div class="team-grid">
                    <div class="team-member">
                        <h3>Dhruv</h3>
                        <p>Data merging and standardization, correlation analysis, scatter plot implementation (Altair), findings summary and recommendations</p>
                    </div>
                    
                    <div class="team-member">
                        <h3>Reagan</h3>
                        <p>Data cleaning and geospatial processing, choropleth dashboard creation (D3), interactive features implementation, design explanations</p>
                    </div>
                    
                    <div class="team-member">
                        <h3>Shreyashi</h3>
                        <p>Statistical analysis and spatial patterns, water violations bar chart, project introduction and data description, visualization takeaways</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Environmental Inequality Analysis Project | DS4200: Information Presentation and Data Visualization</p>
            <p>Northeastern University</p>
        </div>
    </footer>

    <script>
        // Global data variable
        let globalData = [];

        // Load data function
        async function loadData() {
            try {
                const data = await d3.csv('data/final_output.csv');
                
                // Convert string numbers to actual numbers
                data.forEach(d => {
                    d["Air Polution measured by Micrograms per cubic meter"] = +d["Air Polution measured by Micrograms per cubic meter"];
                    d["Percent_COPD"] = +d["Percent_COPD"];
                    d["amount_of_facilities"] = +d["amount_of_facilities"];
                    d["PCTPOVALL_2023"] = +d["PCTPOVALL_2023"];
                    
                    // Convert ethnicity columns to numbers
                    d["Ethnicities.American Indian and Alaska Native Alone"] = +d["Ethnicities.American Indian and Alaska Native Alone"];
                    d["Ethnicities.Asian Alone"] = +d["Ethnicities.Asian Alone"];
                    d["Ethnicities.Black Alone"] = +d["Ethnicities.Black Alone"];
                    d["Ethnicities.Hispanic or Latino"] = +d["Ethnicities.Hispanic or Latino"];
                    d["Ethnicities.Native Hawaiian and Other Pacific Islander Alone"] = +d["Ethnicities.Native Hawaiian and Other Pacific Islander Alone"];
                    d["Ethnicities.Two or More Races"] = +d["Ethnicities.Two or More Races"];
                    d["Ethnicities.White Alone"] = +d["Ethnicities.White Alone"];
                    d["Ethnicities.White Alone\t not Hispanic or Latino"] = +d["Ethnicities.White Alone\t not Hispanic or Latino"];
                });
                
                globalData = data;
                console.log("Data loaded:", data.length, "rows");
                return data;
                
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }

        // Create D3.js bar chart for top facilities
        function createD3FacilitiesChart(data) {
            // Clear previous chart
            d3.select("#d3-facilities-bar-chart").selectAll("*").remove();
            
            // Process data to get top 20 counties
            const facilitiesData = data
                .filter(d => d.amount_of_facilities && d.amount_of_facilities > 0 && d.County && d.Stabr)
                .map(d => ({
                    county_state: `${d.County}, ${d.Stabr}`,
                    amount_of_facilities: +d.amount_of_facilities,
                    copd_rate: +d.Percent_COPD || 0,
                    air_pollution: +d["Air Polution measured by Micrograms per cubic meter"] || 0
                }))
                .sort((a, b) => b.amount_of_facilities - a.amount_of_facilities)
                .slice(0, 20);

            // Set dimensions and margins
            const margin = {top: 20, right: 30, bottom: 60, left: 200};
            const width = 700 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select("#d3-facilities-bar-chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create scales
            const xScale = d3.scaleLinear()
                .domain([0, d3.max(facilitiesData, d => d.amount_of_facilities)])
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(facilitiesData.map(d => d.county_state))
                .range([0, height])
                .padding(0.1);

            // Color scale
            const colorScale = d3.scaleSequential(d3.interpolateViridis)
                .domain([0, d3.max(facilitiesData, d => d.amount_of_facilities)]);

            // Create tooltip
            const tooltip = d3.select(".d3-tooltip");

            // Create bars
            g.selectAll(".d3-bar")
                .data(facilitiesData)
                .enter()
                .append("rect")
                .attr("class", "d3-bar")
                .attr("x", 0)
                .attr("y", d => yScale(d.county_state))
                .attr("width", d => xScale(d.amount_of_facilities))
                .attr("height", yScale.bandwidth())
                .attr("fill", d => colorScale(d.amount_of_facilities))
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke", "black").style("stroke-width", "2px");
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`
                        <strong>${d.county_state}</strong><br/>
                        Industrial Facilities: ${d.amount_of_facilities}<br/>
                        COPD Rate: ${d.copd_rate.toFixed(1)}%<br/>
                        Air Pollution: ${d.air_pollution.toFixed(1)} µg/m³
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).style("stroke", "none");
                    tooltip.transition().duration(500).style("opacity", 0);
                })
                .on("click", function(event, d) {
                    // Toggle selection
                    const isSelected = d3.select(this).classed("selected");
                    g.selectAll(".d3-bar").classed("selected", false).style("opacity", 1);
                    if (!isSelected) {
                        d3.select(this).classed("selected", true);
                        g.selectAll(".d3-bar:not(.selected)").style("opacity", 0.5);
                    }
                });

            // Add axes
            g.append("g")
                .attr("class", "d3-axis")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append("g")
                .attr("class", "d3-axis")
                .call(d3.axisLeft(yScale));

            // Add axis labels
            g.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("County, State");

            g.append("text")
                .attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`)
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Number of Industrial Facilities");

            // Add title
            g.append("text")
                .attr("x", width / 2)
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("font-weight", "bold")
                .text("Top 20 Counties by Industrial Facility Count");
        }

        // Create enhanced Altair scatter plot with better brush selection
        function createScatterPlot(data) {
            const scatterSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": data},
                "mark": {
                    "type": "circle", 
                    "size": 40, 
                    "opacity": 0.7,
                    "stroke": null,
                    "strokeWidth": 0
                },
                "encoding": {
                    "x": {
                        "field": "Air Polution measured by Micrograms per cubic meter",
                        "type": "quantitative",
                        "title": "Air Pollution (µg/m³)",
                        "axis": {"grid": true}
                    },
                    "y": {
                        "field": "Percent_COPD",
                        "type": "quantitative",
                        "title": "COPD Prevalence (%)",
                        "axis": {"grid": true}
                    },
                    "color": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "scale": {"scheme": "plasma", "range": ["#0d1184", "#ed7953", "#fcffa4"]},
                        "title": "Facility Count"
                    },
                    "opacity": {
                        "condition": [
                            {
                                "param": "brush",
                                "value": 0.9
                            },
                            {
                                "param": "click",
                                "value": 1.0
                            }
                        ],
                        "value": 0.05
                    },
                    "size": {
                        "condition": [
                            {
                                "param": "click",
                                "value": 100
                            },
                            {
                                "param": "brush",
                                "value": 80
                            }
                        ],
                        "value": 30
                    },
                    "stroke": {
                        "condition": [
                            {
                                "param": "click",
                                "value": "white"
                            },
                            {
                                "param": "brush",
                                "value": "#ffff00"
                            }
                        ],
                        "value": null
                    },
                    "strokeWidth": {
                        "condition": [
                            {
                                "param": "click",
                                "value": 3
                            },
                            {
                                "param": "brush",
                                "value": 2
                            }
                        ],
                        "value": 0
                    },
                    "tooltip": [
                        {"field": "County", "type": "nominal"},
                        {"field": "Stabr", "type": "nominal", "title": "State"},
                        {"field": "Percent_COPD", "type": "quantitative", "title": "COPD Prevalence (%)", "format": ".1f"},
                        {"field": "Air Polution measured by Micrograms per cubic meter", "type": "quantitative", "title": "Air Pollution (µg/m³)", "format": ".1f"},
                        {"field": "amount_of_facilities", "type": "quantitative", "title": "Industrial Facilities"}
                    ]
                },
                "params": [
                    {
                        "name": "brush",
                        "select": {
                            "type": "interval",
                            "resolve": "global"
                        }
                    },
                    {
                        "name": "click",
                        "select": {
                            "type": "point",
                            "toggle": true
                        }
                    }
                ],
                "width": 700,
                "height": 400,
                "title": {
                    "text": "Air Pollution vs COPD Prevalence by County",
                    "fontSize": 16,
                    "fontWeight": "bold"
                }
            };

            vegaEmbed('#scatter-plot-viz', scatterSpec, {actions: false});
        }

        // Create water violations chart
        function createWaterViolationsChart(data) {
            // Calculate majority group for each county
            const dataWithMajority = data.map(d => {
                const ethnicityColumns = {
                    'Ethnicities.White Alone': 'White',
                    'Ethnicities.Black Alone': 'Black',
                    'Ethnicities.Hispanic or Latino': 'Hispanic or Latino',
                    'Ethnicities.Asian Alone': 'Asian',
                    'Ethnicities.American Indian and Alaska Native Alone': 'American Indian / Alaska Native',
                    'Ethnicities.Native Hawaiian and Other Pacific Islander Alone': 'NHPI',
                    'Ethnicities.Two or More Races': 'Two or More Races',
                    'Ethnicities.White Alone\t not Hispanic or Latino': 'White (Non-Hispanic)'
                };

                let maxValue = 0;
                let majorityGroup = 'Unknown';
                
                Object.entries(ethnicityColumns).forEach(([col, label]) => {
                    const value = parseFloat(d[col]) || 0;
                    if (value > maxValue) {
                        maxValue = value;
                        majorityGroup = label;
                    }
                });

                return { ...d, majority_group: majorityGroup };
            });

            // Process data for water violations
            const violationsData = dataWithMajority
                .filter(d => d["Water Violation"] && d["Water Violation"].toString().toLowerCase() === "yes")
                .reduce((acc, d) => {
                    acc[d.majority_group] = (acc[d.majority_group] || 0) + 1;
                    return acc;
                }, {});

            const violationsArray = Object.entries(violationsData)
                .map(([group, count]) => ({
                    majority_group: group,
                    counties_with_violations: count
                }))
                .sort((a, b) => b.counties_with_violations - a.counties_with_violations);

            const waterSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": violationsArray},
                "mark": {
                    "type": "bar",
                    "color": "#3b0764",
                    "cornerRadius": 4,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "majority_group",
                        "type": "nominal",
                        "sort": "-y",
                        "title": "Majority Race/Ethnicity",
                        "axis": {"labelAngle": -20}
                    },
                    "y": {
                        "field": "counties_with_violations",
                        "type": "quantitative",
                        "title": "Number of Counties with Water Violations"
                    },
                    "opacity": {
                        "condition": {"param": "click", "value": 0.9},
                        "value": 0.7
                    },
                    "stroke": {
                        "condition": {"param": "click", "value": "black"},
                        "value": null
                    },
                    "strokeWidth": {
                        "condition": {"param": "click", "value": 2},
                        "value": 0
                    },
                    "tooltip": [
                        {"field": "majority_group", "type": "nominal", "title": "Majority Group"},
                        {"field": "counties_with_violations", "type": "quantitative", "title": "Counties with Violations"}
                    ]
                },
                "params": [
                    {
                        "name": "click",
                        "select": {"type": "point", "toggle": true}
                    }
                ],
                "width": 650,
                "height": 400
            };

            vegaEmbed('#water-violations-viz', waterSpec, {actions: false});
        }

        // Create Altair facilities bar chart
        function createFacilitiesChart(data, sortOrder = 'descending') {
            let topFacilities = data
                .filter(d => d.amount_of_facilities && d.amount_of_facilities > 0 && d.County && d.Stabr)
                .map(d => ({
                    County_State: `${d.County}, ${d.Stabr}`,
                    amount_of_facilities: +d.amount_of_facilities,
                    Percent_COPD: +d.Percent_COPD || 0,
                    Air_Pollution: +d["Air Polution measured by Micrograms per cubic meter"] || 0
                }));

            // Apply sorting
            if (sortOrder === 'ascending') {
                topFacilities.sort((a, b) => a.amount_of_facilities - b.amount_of_facilities);
            } else if (sortOrder === 'alphabetical') {
                topFacilities.sort((a, b) => a.County_State.localeCompare(b.County_State));
            } else {
                topFacilities.sort((a, b) => b.amount_of_facilities - a.amount_of_facilities);
            }

            topFacilities = topFacilities.slice(0, 20);

            const barSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": topFacilities},
                "mark": {
                    "type": "bar",
                    "cornerRadius": 4,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "title": "Number of Facilities"
                    },
                    "y": {
                        "field": "County_State",
                        "type": "nominal",
                        "title": "County, State",
                        "sort": null
                    },
                    "color": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "scale": {"range": ["#2e1065", "#ede9fe"]},
                        "title": "Facility Count"
                    },
                    "opacity": {
                        "condition": {"param": "click", "value": 1.0},
                        "value": 0.8
                    },
                    "stroke": {
                        "condition": {"param": "click", "value": "black"},
                        "value": null
                    },
                    "strokeWidth": {
                        "condition": {"param": "click", "value": 2},
                        "value": 0
                    },
                    "tooltip": [
                        {"field": "County_State", "type": "nominal", "title": "County, State"},
                        {"field": "amount_of_facilities", "type": "quantitative", "title": "Industrial Facilities"},
                        {"field": "Percent_COPD", "type": "quantitative", "title": "COPD Rate (%)", "format": ".1f"},
                        {"field": "Air_Pollution", "type": "quantitative", "title": "Air Pollution (µg/m³)", "format": ".1f"}
                    ]
                },
                "params": [
                    {
                        "name": "click",
                        "select": {"type": "point", "toggle": true}
                    }
                ],
                "width": 700,
                "height": 400
            };

            vegaEmbed('#facilities-bar-viz', barSpec, {actions: false});
        }

        // Initialize all visualizations
        loadData().then(data => {
            if (data.length === 0) {
                console.error("No data loaded! Check if final_output.csv exists and is accessible.");
                return;
            }
            
            console.log("Initializing all visualizations...");
            createScatterPlot(data);
            createD3FacilitiesChart(data);
            createWaterViolationsChart(data);
        }).catch(error => {
            console.error("Error initializing visualizations:", error);
        });

    </script>
</body>
</html>