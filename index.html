<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapping and Analyzing Environmental Inequality in the U.S.</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <h1>Environmental Inequality in the U.S.</h1>
                <ul class="nav-links">
                    <li><a href="#introduction">Introduction</a></li>
                    <li><a href="#data">Data</a></li>
                    <li><a href="#visualizations">Visualizations</a></li>
                    <li><a href="#findings">Findings</a></li>
                    <li><a href="#team">Team</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <!-- Introduction Section -->
        <section id="introduction" class="section">
            <div class="container">
                <h2>Introduction</h2>
                <div class="intro-content">
                    <p>Across the United States, many communities face long-term health consequences from industrial activity and environmental neglect. Incidents such as toxic chemical releases, lead contamination, and poor air quality highlight how pollution disproportionately affects low-income areas and people of color.</p>
                    
                    <p>Understanding these disparities is critical for identifying where policy and intervention are most needed. By examining the relationship between pollution exposure, socioeconomic factors, and health outcomes, this project seeks to uncover patterns of environmental injustice and health disparities.</p>
                    
                    <p>Studying these connections not only reveals the human cost of industrial and governmental oversight but also emphasizes the urgent need for equitable public health protections and sustainable environmental practices.</p>
                </div>
                
                <div class="reference-images">
                    <div class="reference-image">
                        <img src="images/ref_image_1.png" alt="Environmental Health Context - Reference Image 1" style="width: 85%; height: 315px; object-fit: cover; border-radius: 8px;">
                        <p class="image-caption">Reference Image 1: Environmental Health Context</p>
                    </div>
                    <div class="reference-image">
                        <img src="images/ref_image_2.png" alt="Community Impact Visualization - Reference Image 2" style="width: 85%; height: 315px; object-fit: cover; border-radius: 8px;">
                        <p class="image-caption">Reference Image 2: Community Impact Visualization</p>
                    </div>
                </div>

                <div class="references">
                    <h3>References</h3>
                    <ul>
                        <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5555375/" target="_blank">Social and Built Environmental Correlates of Predicted Blood Lead Levels in the Flint Water Crisis - PMC</a></li>
                        <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8234030/" target="_blank">Air pollution and its impact on cancer incidence, cancer care and cancer outcomes - PMC</a></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Data Section -->
        <section id="data" class="section">
            <div class="container">
                <h2>Data Sources and Methodology</h2>
                <p>This analysis combines multiple county-level datasets to examine environmental health disparities across the United States. Our data sources include comprehensive environmental, demographic, and health indicators necessary to identify patterns of environmental injustice.</p>
                
                <div class="data-grid">
                    <div class="data-card">
                        <h4>Socioeconomic Data</h4>
                        <ul>
                            <li>Poverty Data 2023 (~3,000 counties)</li>
                            <li>Corrected county demographics</li>
                            <li>2024 US census data</li>
                        </ul>
                    </div>
                    <div class="data-card">
                        <h4>Environmental Exposure</h4>
                        <ul>
                            <li>HDPulse environmental data export</li>
                            <li>Corrected facilities data</li>
                            <li>Integrated environmental indicators</li>
                        </ul>
                    </div>
                    <div class="data-card">
                        <h4>Health Outcomes</h4>
                        <ul>
                            <li>County COPD prevalence data</li>
                            <li>Incidence and mortality rates (incd.csv)</li>
                            <li>Merged final health indicators</li>
                        </ul>
                    </div>
                </div>

                <div class="methodology">
                    <h3>Data Processing Methodology</h3>
                    <p>All datasets were merged using Federal Information Processing Standards (FIPS) codes to ensure accurate county-level alignment. Missing data was handled through careful imputation and outlier analysis. Variables were standardized for cross-county comparison and converted to geospatial format for mapping applications.</p>
                </div>
            </div>
        </section>

        <!-- Visualizations Section -->
        <section id="visualizations" class="section">
            <div class="container">
                <h2>Interactive Data Visualizations</h2>
                <p>Explore the relationship between environmental factors, demographics, and health outcomes through our interactive visualizations.</p>

                <!-- Interactive Air Pollution vs COPD Scatter Plot -->
                <div class="visualization-container">
                    <h3>Air Pollution vs. COPD Prevalence</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> 
                        <br>• <strong>Brush Selection:</strong> Drag to select a rectangular area - selected points become more visible
                        <br>• <strong>Zoom:</strong> After brushing/selecting an area, double-click inside the selection to zoom into that region
                        <br>• <strong>Reset:</strong> Double-click outside any selection to reset the zoom
                        <br>• <strong>Hover:</strong> Mouse over points for detailed county information
                        <br><br>This scatter plot shows the relationship between air pollution concentration (µg/m³) and COPD prevalence (%) across U.S. counties, with each point colored by the number of industrial facilities in that county.</p>
                    </div>
                    <div class="visualization">
                        <div id="scatter-plot-viz" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Interactive Water Violations Bar Chart -->
                <div class="visualization-container">
                    <h3>Water Quality Violations by Demographics</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> Hover for detailed counts and percentages, click bars to highlight. This bar chart shows how many U.S. counties with drinking water violations fall into each majority race or ethnicity category.</p>
                    </div>
                    <div class="visualization">
                        <div id="water-violations-viz" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Interactive Industrial Facilities Bar Chart -->
                <div class="visualization-container">
                    <h3>Top 20 Counties by Industrial Facility Count</h3>
                    <div class="viz-description">
                        <p><strong>Interactive Features:</strong> Hover for exact counts, click to select counties, sort controls. This bar chart highlights the 20 U.S. counties with the highest number of industrial facilities.</p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="sort-control" style="font-weight: 600; margin-right: 10px;">Sort by:</label>
                        <select id="sort-control" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="descending">Highest to Lowest</option>
                            <option value="ascending">Lowest to Highest</option>
                            <option value="alphabetical">Alphabetical</option>
                        </select>
                    </div>
                    <div class="visualization">
                        <div id="facilities-bar-viz" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Quadrant Choropleth Maps -->
                <div class="visualization-container">
                    <h3>County-Level Environmental and Health Indicators</h3>
                    <div class="viz-description">
                        <p>This comprehensive view displays multiple environmental and health indicators across U.S. counties, including industrial facility counts and COPD prevalence rates, enabling comparison of environmental burden and health outcomes.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/quadrant_maps.png" alt="Quadrant Choropleth Maps showing Environmental and Health Indicators" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Geographic clustering reveals that areas with higher industrial facility concentrations (top maps) often correspond with elevated COPD rates (bottom right), particularly visible in industrial regions and urban centers.</p>
                    </div>
                </div>

                <!-- Income/Poverty Choropleth Map -->
                <div class="visualization-container">
                    <h3>County-Level Socioeconomic Distribution</h3>
                    <div class="viz-description">
                        <p>This choropleth map visualizes socioeconomic indicators across U.S. counties, providing context for understanding how economic factors intersect with environmental health disparities.</p>
                    </div>
                    <div class="visualization">
                        <img src="images/income_map.png" alt="County-Level Income Distribution Map" style="width: 100%; max-width: 900px; height: auto; border-radius: 8px;">
                    </div>
                    <div class="viz-takeaway">
                        <h4>Key Takeaway:</h4>
                        <p>Socioeconomic disparities are clearly visible across the United States, with lower-income areas (darker regions) often corresponding to areas with higher environmental burden, supporting environmental justice concerns.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Findings Section -->
        <section id="findings" class="section">
            <div class="container">
                <h2>Summary of Findings</h2>
                
                <div class="findings-summary">
                    <p>Through comprehensive analysis of environmental, demographic, and health data across U.S. counties, this study reveals significant patterns of environmental inequality and their relationship to public health outcomes. Our visualizations demonstrate clear connections between industrial activity, environmental quality, and community health disparities.</p>
                </div>
                
                <div class="findings-grid">
                    <div class="finding-card">
                        <h3>Industrial Activity Concentration</h3>
                        <p>Industrial facilities are heavily concentrated in major metropolitan areas like Harris County, TX and Los Angeles County, CA, with the top 20 counties containing disproportionate numbers of facilities. This concentration creates localized environmental burden hotspots with significant implications for air and water quality in these regions.</p>
                    </div>
                    
                    <div class="finding-card">
                        <h3>Air Pollution and Respiratory Health</h3>
                        <p>The relationship between air pollution and COPD prevalence shows that while pollution is not the sole factor affecting respiratory health, counties with higher industrial facility counts consistently show elevated air pollution levels, creating identifiable hotspots for poor air quality and higher COPD rates.</p>
                    </div>
                    
                    <div class="finding-card">
                        <h3>Water Quality Across Demographics</h3>
                        <p>Water quality violations occur across communities of different racial and ethnic majorities, with the majority of affected counties being predominantly White. This pattern reflects broader population demographics but also demonstrates that water quality issues span diverse communities rather than being concentrated in specific demographic groups.</p>
                    </div>
                </div>

                <div class="future-work">
                    <h3>Future Research and Policy Implications</h3>
                    <p>Future research should examine longitudinal trends in environmental health disparities, investigate the effectiveness of current environmental regulations in high-burden areas, and explore targeted interventions for communities facing multiple environmental stressors. Policy makers should consider the concentrated nature of industrial activity when developing environmental health protections and ensure equitable enforcement across all communities.</p>
                </div>
            </div>
        </section>

        <!-- Team Section -->
        <section id="team" class="section">
            <div class="container">
                <h2>Project Team</h2>
                <div class="team-grid">
                    <div class="team-member">
                        <h3>Dhruv</h3>
                    </div>
                    
                    <div class="team-member">
                        <h3>Reagan</h3>
                    </div>
                    
                    <div class="team-member">
                        <h3>Shreyashi</h3>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Environmental Inequality Analysis Project | DS4200: Information Presentation and Data Visualization</p>
            <p>Northeastern University</p>
        </div>
    </footer>

    <script>
        // Load your data - replace with actual data loading
        async function loadData() {
            try {
                const data = await d3.csv('data/final_output.csv');
                
                // Convert string numbers to actual numbers for calculations
                data.forEach(d => {
                    d["Air Polution measured by Micrograms per cubic meter"] = +d["Air Polution measured by Micrograms per cubic meter"];
                    d["Percent_COPD"] = +d["Percent_COPD"];
                    d["amount_of_facilities"] = +d["amount_of_facilities"];
                    d["PCTPOVALL_2023"] = +d["PCTPOVALL_2023"];
                    
                    // Convert ethnicity columns to numbers
                    d["Ethnicities.American Indian and Alaska Native Alone"] = +d["Ethnicities.American Indian and Alaska Native Alone"];
                    d["Ethnicities.Asian Alone"] = +d["Ethnicities.Asian Alone"];
                    d["Ethnicities.Black Alone"] = +d["Ethnicities.Black Alone"];
                    d["Ethnicities.Hispanic or Latino"] = +d["Ethnicities.Hispanic or Latino"];
                    d["Ethnicities.Native Hawaiian and Other Pacific Islander Alone"] = +d["Ethnicities.Native Hawaiian and Other Pacific Islander Alone"];
                    d["Ethnicities.Two or More Races"] = +d["Ethnicities.Two or More Races"];
                    d["Ethnicities.White Alone"] = +d["Ethnicities.White Alone"];
                    d["Ethnicities.White Alone\t not Hispanic or Latino"] = +d["Ethnicities.White Alone\t not Hispanic or Latino"];
                });
                
                console.log("Data loaded:", data.length, "rows");
                console.log("Sample row:", data[0]);
                return data;
                
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }

        // Create interactive scatter plot
        function createScatterPlot(data) {
            const scatterSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": data},
                "mark": {"type": "circle", "size": 60, "opacity": 0.8},
                "encoding": {
                    "x": {
                        "field": "Air Polution measured by Micrograms per cubic meter",
                        "type": "quantitative",
                        "title": "Air Pollution (µg/m³)",
                        "scale": {"domain": {"param": "brush", "encoding": "x"}}
                    },
                    "y": {
                        "field": "Percent_COPD",
                        "type": "quantitative",
                        "title": "COPD Prevalence (%)",
                        "scale": {"domain": {"param": "brush", "encoding": "y"}}
                    },
                    "color": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "scale": {"scheme": "viridis"},
                        "title": "Facility Count"
                    },
                    "opacity": {
                        "condition": {"param": "brush", "value": 0.8},
                        "value": 0.3
                    },
                    "tooltip": [
                        {"field": "County", "type": "nominal"},
                        {"field": "Stabr", "type": "nominal", "title": "State"},
                        {"field": "Percent_COPD", "type": "quantitative", "title": "COPD Prevalence (%)", "format": ".1f"},
                        {"field": "Air Polution measured by Micrograms per cubic meter", "type": "quantitative", "title": "Air Pollution (µg/m³)", "format": ".1f"},
                        {"field": "amount_of_facilities", "type": "quantitative", "title": "Industrial Facilities"}
                    ]
                },
                "params": [
                    {
                        "name": "brush",
                        "select": {"type": "interval", "encodings": ["x", "y"], "zoom": true}
                    },
                    {
                        "name": "click",
                        "select": {"type": "point", "toggle": true}
                    }
                ],
                "resolve": {"scale": {"color": "independent"}},
                "width": 700,
                "height": 400
            };

            vegaEmbed('#scatter-plot-viz', scatterSpec, {actions: false}).then(result => {
                // Add custom zoom and pan instructions
                const view = result.view;
                
                // Add mouse wheel zoom
                view.addEventListener('wheel', function(event, item) {
                    event.preventDefault();
                    const delta = event.deltaY;
                    const zoom = delta > 0 ? 0.9 : 1.1;
                    
                    // This is a simplified zoom - Vega-Lite handles most of this automatically
                    console.log('Mouse wheel zoom:', zoom);
                });
            });
        }

        // Create water violations chart
        function createWaterViolationsChart(data) {
            // First, calculate majority group for each county
            const dataWithMajority = data.map(d => {
                const ethnicityColumns = {
                    'Ethnicities.White Alone': 'White',
                    'Ethnicities.Black Alone': 'Black',
                    'Ethnicities.Hispanic or Latino': 'Hispanic or Latino',
                    'Ethnicities.Asian Alone': 'Asian',
                    'Ethnicities.American Indian and Alaska Native Alone': 'American Indian / Alaska Native',
                    'Ethnicities.Native Hawaiian and Other Pacific Islander Alone': 'NHPI',
                    'Ethnicities.Two or More Races': 'Two or More Races',
                    'Ethnicities.White Alone\t not Hispanic or Latino': 'White (Non-Hispanic)'
                };

                let maxValue = 0;
                let majorityGroup = 'Unknown';
                
                Object.entries(ethnicityColumns).forEach(([col, label]) => {
                    const value = parseFloat(d[col]) || 0;
                    if (value > maxValue) {
                        maxValue = value;
                        majorityGroup = label;
                    }
                });

                return { ...d, majority_group: majorityGroup };
            });

            // Process data for water violations by demographic group
            const violationsData = dataWithMajority
                .filter(d => d["Water Violation"] && d["Water Violation"].toString().toLowerCase() === "yes")
                .reduce((acc, d) => {
                    acc[d.majority_group] = (acc[d.majority_group] || 0) + 1;
                    return acc;
                }, {});

            const violationsArray = Object.entries(violationsData)
                .map(([group, count]) => ({
                    majority_group: group,
                    counties_with_violations: count
                }))
                .sort((a, b) => b.counties_with_violations - a.counties_with_violations);

            const waterSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": violationsArray},
                "mark": {
                    "type": "bar",
                    "color": "#3b0764",
                    "cornerRadius": 4,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "majority_group",
                        "type": "nominal",
                        "sort": "-y",
                        "title": "Majority Race/Ethnicity",
                        "axis": {"labelAngle": -20}
                    },
                    "y": {
                        "field": "counties_with_violations",
                        "type": "quantitative",
                        "title": "Number of Counties with Water Violations"
                    },
                    "opacity": {
                        "condition": {"param": "click", "value": 0.9},
                        "value": 0.7
                    },
                    "stroke": {
                        "condition": {"param": "click", "value": "black"},
                        "value": null
                    },
                    "strokeWidth": {
                        "condition": {"param": "click", "value": 2},
                        "value": 0
                    },
                    "tooltip": [
                        {"field": "majority_group", "type": "nominal", "title": "Majority Group"},
                        {"field": "counties_with_violations", "type": "quantitative", "title": "Counties with Violations"}
                    ]
                },
                "params": [
                    {
                        "name": "click",
                        "select": {"type": "point", "toggle": true}
                    }
                ],
                "width": 650,
                "height": 400
            };

            vegaEmbed('#water-violations-viz', waterSpec, {actions: false});
        }

        // Create facilities bar chart
        function createFacilitiesChart(data, sortOrder = 'descending') {
            console.log("Creating facilities chart with sort order:", sortOrder);
            
            let topFacilities = data
                .filter(d => d.amount_of_facilities > 0)
                .map(d => ({
                    ...d,
                    County_State: `${d.County}, ${d.Stabr}`
                }));

            // Apply sorting based on the parameter
            if (sortOrder === 'ascending') {
                console.log("Sorting ascending by facility count");
                topFacilities.sort((a, b) => a.amount_of_facilities - b.amount_of_facilities);
            } else if (sortOrder === 'alphabetical') {
                console.log("Sorting alphabetically");
                topFacilities.sort((a, b) => a.County_State.localeCompare(b.County_State));
            } else { // descending
                console.log("Sorting descending by facility count");
                topFacilities.sort((a, b) => b.amount_of_facilities - a.amount_of_facilities);
            }

            // Take top 20 after sorting
            topFacilities = topFacilities.slice(0, 20);

            // Determine y-axis sort for Vega-Lite
            let ySortConfig;
            if (sortOrder === 'alphabetical') {
                ySortConfig = "ascending";
            } else if (sortOrder === 'ascending') {
                ySortConfig = "x";  // Sort by x-value (facility count) ascending
            } else {
                ySortConfig = "-x"; // Sort by x-value (facility count) descending
            }

            const barSpec = {
                "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
                "data": {"values": topFacilities},
                "mark": {
                    "type": "bar",
                    "cornerRadius": 4,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "title": "Number of Facilities"
                    },
                    "y": {
                        "field": "County_State",
                        "type": "nominal",
                        "sort": ySortConfig,
                        "title": "County, State"
                    },
                    "color": {
                        "field": "amount_of_facilities",
                        "type": "quantitative",
                        "scale": {"range": ["#2e1065", "#ede9fe"]},
                        "title": "Facility Count"
                    },
                    "opacity": {
                        "condition": {"param": "click", "value": 1.0},
                        "value": 0.8
                    },
                    "stroke": {
                        "condition": {"param": "click", "value": "black"},
                        "value": null
                    },
                    "strokeWidth": {
                        "condition": {"param": "click", "value": 2},
                        "value": 0
                    },
                    "tooltip": [
                        {"field": "County_State", "type": "nominal", "title": "County, State"},
                        {"field": "amount_of_facilities", "type": "quantitative", "title": "Industrial Facilities"},
                        {"field": "Percent_COPD", "type": "quantitative", "title": "COPD Rate (%)", "format": ".1f"},
                        {"field": "Air Polution measured by Micrograms per cubic meter", "type": "quantitative", "title": "Air Pollution (µg/m³)", "format": ".1f"}
                    ]
                },
                "params": [
                    {
                        "name": "click",
                        "select": {"type": "point", "toggle": true}
                    }
                ],
                "width": 700,
                "height": 400
            };

            console.log("Bar chart spec created, embedding...");
            vegaEmbed('#facilities-bar-viz', barSpec, {actions: false});
        }

        // Initialize visualizations
        loadData().then(data => {
            console.log("Initializing visualizations with data:", data.length, "rows");
            
            if (data.length === 0) {
                console.error("No data loaded! Check if final_output.csv exists and is accessible.");
                return;
            }
            
            console.log("Sample data point:", data[0]);
            console.log("Available columns:", Object.keys(data[0]));
            
            // Check for required columns
            const requiredColumns = [
                "Air Polution measured by Micrograms per cubic meter",
                "Percent_COPD", 
                "amount_of_facilities",
                "County",
                "Stabr",
                "Water Violation"
            ];
            
            const missingColumns = requiredColumns.filter(col => !(col in data[0]));
            if (missingColumns.length > 0) {
                console.error("Missing required columns:", missingColumns);
            }
            
            createScatterPlot(data);
            createWaterViolationsChart(data);
            createFacilitiesChart(data);
        }).catch(error => {
            console.error("Error initializing visualizations:", error);
        });

        // Add sort control functionality
        document.getElementById('sort-control').addEventListener('change', function(e) {
            console.log('Sort changed to:', e.target.value);
            // Recreate the facilities chart with new sorting
            loadData().then(data => {
                createFacilitiesChart(data);
            });
        });
    </script>
</body>
</html>